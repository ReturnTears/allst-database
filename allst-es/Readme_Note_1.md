《Elasticsearch全面解析与实践》

1.1 Elasticsearch概述

◆ Elasticsearch（简称ES）是一个开源的、高扩展的、分布式的、提供多用户能力的全文搜索引擎，也是一个基于Lucene搜索的服务器，可以近乎实时地存储和搜索数据

◆ 在云计算环境中，Elasticsearch能够达到数据的实时搜索，而且性能非常稳定，安装与使用也非常便捷

◆ Elasticsearch在Java、.NET、PHP、Python、Apache Groovy、Ruby等程序设计语言中都可以使用

◆ Elasticsearch能很方便地用于对大量数据进行搜索和分析，充分利用Elasticsearch的水平伸缩性，能够使数据在生产环境中变得更富有价值


1.2 Elasticsearch与Solr比较

◆ Elasticsearch部署和安装简单，并自带分布式协调管理功能；而Solr需要依赖ZooKeeper进行分布式协调管理

◆ Elasticsearch基本是开箱即用，解压之后就可以使用；相对而言，Solr使用难度较大

◆ Solr支持多种数据格式的文件，比如JSON、XML、CSV等；而Elasticsearch仅仅支持JSON数据格式的文件

◆ Solr数据搜索的速度快，但是数据插入和数据删除的速度都比较慢，它主要用于电商平台和数据搜索多的应用；而Elasticsearch创建索引（数据插入）和数据搜索的速度都比较快

◆ Solr是传统的搜索应用方案；而Elasticsearch更适用于新兴的近实时搜索

◆ Solr提供的功能繁杂；而Elasticsearch注重核心功能，高级功能大多数由第三方插件提供，例如图形化界面需要Kibana来支撑


1.3 为什么要学习Elasticsearch

◆ 在当前的软件行业中，搜索功能是软件系统或平台的基本功能，Elasticsearch可为相应的软件打造良好的搜索体验

◆ Elasticsearch具备非常强大的数据分析能力。虽然Hadoop也可以进行大数据分析，但是没有Elasticsearch这样强大的分析能力

◆ Elasticsearch使用方便，既可以将其安装在PC上，又可以部署在生产环境中

◆ 在当今的大数据时代，具备了近实时的搜索和分析能力，企业才能拥有核心的竞争力，才能洞见未来


1.4 Elasticsearch的主要功能及应用场景

◆ 海量数据的分布式存储以及集群管理，能达到服务与数据的高可用以及系统架构的水平扩展

◆ 近实时的数据搜索能力，能够对结构化数据、全文数据、地理位置等类型的数据进行处理和分析

◆ 海量数据的实时分析功能和各种强大的聚合功能。
Elasticsearch的主要应用场景如下：
1）网站搜索、代码搜索等。
2）日志管理、日志分析、日志安全指标监控、应用性能监控、Web抓取舆情分析等

◆ 利用Elasticsearch的高性能和分布式部署特征，可以对海量的业务订单数据进行分析和处理，还能利用Elasticsearch的聚合函数和分析能力统计出各种各样的数据报表

◆ Elasticsearch是与Logstash（数据收集和日志解析引擎）和Kibana（数据分析和可视化平台）一起开发的，这3个产品被设计成一个集成的解决方案（ELK），被广泛运用于大数据近实时分析领域，包括日志分析、指标监控、信息安全等

◆ 图1-3　Kibana生成的数据面板

◆ Elasticsearch除了和Kibana结合之外，还可以单独使用来实现数据库存储并且对数据进行全文搜索

◆ Logstash是一个动态数据收集管道，它拥有可扩展的插件生态系统，支持从不同来源收集数据和转换数据（过滤和处理），并将转换后的数据发送到不同的存储库中

◆ Logstash具有如下特点

◆ ）实时性。可实时解析数据并对数据进行过滤处理

◆ 可扩展性。具有200多个插件，可接收的数据来源有文本数据以及Redis、Kafka、MQ等存储的数据

◆ ）可靠性与安全性。Logstash会通过持久化队列来保证至少将数据送达一次，同时对数据进行传输加密

◆ 实时监控能力。对可以接收的数据源进行监控，一旦数据源产生新的数据就立刻传输

◆ Beats+MQ+Logstash+Elasticsearch+Kibana结合方案的架构图


1.5 Elasticsearch的安装

◆ Elasticsearch是一个非常占用内存的程序，如果只是为了学习如何使用Elasticsearch，则可以在启动过程中设置使用内存的限制

◆ 配置文件为Elasticsearch根目录下的config文件夹中的jvm.options文件。可使用如下两个参数进行内存大小限制的配置：

◆ 修改配置文件之后，重新启动即可。如果只是学习如何使用Elasticsearch，建议把这两个参数值都修改成1GB或者512MB

◆ Docker Desktop是Docker在Windows 10和macOS操作系统上的官方安装文件，使用Docker Desktop安装依然要先在虚拟机中安装Linux，再安装Docker

◆ （1）安装Hyper-V虚拟机
Hyper-V是微软开发的虚拟机，类似于VMware或VirtualBox，仅适用于Windows 10。这是Docker Desktop for Windows所使用的虚拟机（这个虚拟机一旦启用，VirtualBox、VMware Workstation 15及以下版本将无法使用。如果读者必须在计算机上使用其他虚拟机，请不要使用Hyper-V）

◆ 2. 在Windows环境下安装Kibana


2.1 Elasticsearch的基本概念和相关术语

◆ 集群（Cluster）：集群由一个唯一的名字标识，默认为Elasticsearch。集群名称非常重要，具有相同集群名称的节点才会组成一个集群。集群名称可以在配置文件中指定。后面章节介绍搭建集群的时候将会介绍配置方式。需要注意的是，Elasticsearch中一个节点也被称为集群

◆ 节点（Node）：用于存储集群的数据，参与集群的索引和搜索功能。像集群有名字一样，节点也有自己的名字，默认在启动时会以一个随机的UUID的前7个字符作为节点的名字，用户可以为其指定任意的名字。多个节点通过同一个集群名在网络中发现同伴组成一个集群。一个节点也可以是集群

◆ 索引（Index）：索引是一个文档数据的集合。每个索引都有唯一的名称，用户通过这个名称来操作它。一个集群中可以有任意多个索引。

◆ 类型（Type）：在一个索引中，可以存放不同类型的文档，如用户数据、订单数据等。一个索引中只存放一类数据

◆ 文档（Document）：用JSON格式来表示，存储在索引库中的一条数据

◆ 分片（Shard）：在创建索引时可以指定分成多少个分片来存储。每个分片本身也是一个功能完善且独立的“索引”，可以被放置在集群的任意节点上，从而实现负载均衡。合理的分片数量可以提高Elasticsearch服务的性能

◆ 复制（Replication）：一个分片可以有多个副本，以防止数据丢失和避免数据丢失后服务不可用

◆ 关系型数据库和Elasticsearch比较

◆ 在关系型数据库中，用户会创建数据库；在Elasticsearch中对应的是创建索引，俗称索引库。关系型数据库中的表在Elasticsearch中已经没有对应的项。对于关系型数据库中的行，在Elasticsearch中称为文档。而关系型数据库的列在Elasticsearch中是由字段体现的，表结构使用映射体现。因此，Elasticsearch的大体架构就是创建索引库，也可以给索引库指定映射和字段类型，在Elasticsearch索引库中存储的基本单位就是文档数据


2.2 Elasticsearch操作实例

◆ Elasticsearch是一个遵循RESTful风格的搜索和数据分析引擎，所以一般情况下，调用Elasticsearch的API都是遵循RESTful风格的。它的操作和操作关系型数据库的SQL语句存在差异，不过Elasticsearch也支持特定情况下的SQL操作

◆ RESTful风格是一种软件架构风格，而不是标准，只是提供了一组设计原则和约束条件。它主要用于客户端和服务器交互类的软件，基于这个风格设计的软件更简洁，更有层次，更易于实现缓存等机制

◆ 如上语句创建了一个名为dbindex的索引库，插入数据的文档_id是1，而{}中包含的是对应的字段名称和字段值。

◆ _doc是Elasticsearch默认的文档类型，用户在操作过程中不需要关心_doc，如果要查询dbindex索引库中的数据

◆ 文档详细信息显示在右边窗口的_source对象中，从文档信息中可以了解到，文档主键的默认字段名称是_id。

◆ 从dbindex索引库中查询_id等于2的文档的详细信息，可以看出found字段的结果是false，表示没有找到此文档数据。当找不到文档数据时，返回结果中不会存在_source对象值。

◆ 替换文档或者修改文档内容也可以用此语句，只要保证文档_id字段值在操作的索引数据库中存在即可

◆ PUT语句在执行的时候有两种效果：一种是文档_id字段值不存在时，直接进行文档插入；另一种是存在此文档_id字段值时，进行文档内容替换

◆ 在文档_id等于1的文档中增加address字段，执行完成后，返回的result字段结果是updated，这表示当下执行的是文档替换操作，并且提示文档替换成功

◆ 用户也可以执行下面的语句查询dbindex索引库中的所有数据：

◆ 在使用PUT创建文档的过程中，如果索引数据库中存在此文档_id数据，则进行替换操作，如果不存在，则进行新增操作，并且在此操作中需要指定文档_id字段值

◆ 在实际业务环境中，文档_id字段值与我们进行数据负载均衡有很大关系，一般情况下用户会选择系统默认生成的文档_id字段值。

◆ 在Elasticsearch中，文档的唯一字段（或者说主键）名称是_id，而不是id

◆ 在使用POST新增文档的时候不能指定文档_id（主键字段）​，只能由系统自动生成。当指定了_id字段之后，执行结果会返回异常信息

◆ 直接使用PUT根据_id对文档内容进行修改，Elasticsearch也支持使用POST对文档进行修改

◆ PUT执行修改操作时，会对文档的整个内容进行替换。

◆ POST执行修改操作时，如果字段在文档中，则修改此字段的值；如果字段不在文档中，则把此字段加入文档信息中。

◆ 前面使用POST对文档进行了插入和修改，POST也支持数据查询，可以通过POST查询指定索引库的所有数据

◆ 为批量删除了两条语句，所以返回了两条结果，每一条信息都包含操作类型（result字段）和执行结果（successful字段）​。可

◆ GET语句不仅可以查询文档信息，还可以查询服务中所有的索引库以及索引库的结构信息


2.3 Elasticsearch映射

◆ 映射（Mapping）是定义文档及其包含的字段如何存储在索引库中的过程。每个文档都是一个字段的集合，每个字段都有各自的数据类型

◆ 映射数据时，可以创建一个映射的定义，其中包含与文档相关字段的列表。映射定义还包括元数据字段（如_source字段）​，它自定义如何处理文档关联的元数据，而Elasticsearch支持动态映射和显式映射。每种方法根据不同的使用情况有不同的好处。如果要明确定义映射或者更好地控制创建字段和字段类型，则可以利用Elasticsearch的显式映射

◆ 动态映射方便用户快速写入索引数据。Elasticsearch会根据写入的文档内容自动添加字段和字段类型，用户只负责写入具体的数据即可。

◆ 显式映射需要用户精确地选择如何定义映射，例如哪些字符串字段应被视为全文字段，哪些字段是数字或者日期格式。显式索引是用于控制动态添加字段映射的自定义规则，而且在显示映射中使用runtime（运行时映射）时无须重新创建索引就可以更改数据存储的规则。

◆ 动态映射是Elasticsearch非常重要的功能之一，使用户不需要关注存储结果，能够在业务中尽快使用数据进行搜索。使用动态映射在写入索引文档数据时，不需要先创建索引和定义字段。索引中的字段和字段类型都将自动创建

◆ 以上语句创建了一个名为datadb的索引库，然后为此索引库添加count字段，该字段的数据类型是long，而long类型都是动态映射自动生成的

◆ Elasticsearch在用户写入数据时检测到新的字段时，会动态地将该字段添加到类型映射中，由dynamic参数来控制此行为。用户可以通过将dynamic参数设置为true或明确指示Elasticsearch根据传入的文档来动态创建字段。

◆ 启用date_detection选项（默认启用）​，在检查新添加的字符串字段内容是否与指定的任何日期模式匹配时，如果找到匹配项，则会添加一个具有date格式的新字段

◆ 执行上面的语句，系统会自动创建一个myindex索引库，新建的字段名称是create_date，其字段类型为date类型。我们还可以通过下面的语句查看索引库的映射信息。

◆ 如果想要禁用日期检测，把date_detection参数设置为false即可，

◆ 用户可以通过修改dynamic_date_formats参数的值来自定义想使用的日期格式

◆ 虽然JSON支持原生的浮点和整数数据类型，但是有些应用程序或程序设计语言可能会将数字呈现为字符串。正确的解决方案是显式映射这些字段，启用数字检测（默认情况下禁用）以自动执行此操作

◆ 动态映射模板使得在默认的动态字段映射规则之外能够更好地控制Elasticsearch如何映射数据。用户可以通过将dynamic参数设置为true来启用动态映射模式，然后使用动态模板来定义自定义映射，这些映射可以根据匹配条件应用于动态添加的字段

◆ match_mapping_type：表示对Elasticsearch检测到的数据类型进行操作。

◆ match和unmatch：表示使用模式匹配来匹配字段名称。

◆ 如果想要将某种类型的新字段动态映射为“运行时”字段，则需要在索引映射信息中把dynamic参数的值设置为runtime。同样，也可以使用默认的动态映射规则，然后创建动态模板，将特定字段映射为“运行时”字段。

◆ 以上语句定义了一个名为one的动态模板和一个名为two的动态模板，字段类型匹配通过match_mapping_type属性来进行控制，当添加文档的时候，如果Elasticsearch程序中的JsonParser对象解析出来的类型是match_mapping_type指定的类型，程序就会使用对应的mapping作为映射规则。

◆ 默认情况下，Elasticsearch会将字符串字段映射为text类型的字段（该字段还带有keyword子字段）​。如

◆ 如果我们的业务仅关心字符串字段的全文搜索并且不打算进行聚合、排序或精确搜索，可以指示Elasticsearch将字符串映射为text类型

◆ 如果在业务中用户不关心评分（索引中文档数据内容和用户搜索内容的匹配度，匹配度越高，评分就越高，数据越有可能是用户想要搜索的内容）​，那么禁用索引中的评分可以节省一些存储空间

◆ 在使用Elasticsearch进行时间序列分析时，通常会有许多数字字段，用户一般会对这些字段进行聚合计算，并不会通过这些字段进行搜索。在这种情况下，我们可以关闭对这些字段创建索引的功能，这样做不仅可以节省磁盘空间，还可以提升索引库的性能。

◆ 以上语句创建了两个动态映射模板：一个是unindexed_longs，当检测到字段的数值是long类型时，会禁止为此字段创建索引；另一个是unindexed_doubles，当检测到字段的数值是double类型时，会禁止为此字段创建索引

◆ 若要根据字段名称进行映射控制，则需要设置match、unmatch、pattern参数的值。利用这些参数可以使用模糊匹配或者正则表达式找到字段的对应映射模板

◆ 由以上语句可知，txt_1name字段匹配到了名为txt_as_strings的映射模板，该字段的数据类型与其他设置将根据txt_as_strings映射模板来动态创建。而address字段没有匹配到任何映射模板，那么数据类型与相关设置将使用系统默认的设置。long_score字段匹配到了名为longs_as_strings的映射模板，那么该字段的数据类型与其他设置将根据longs_as_strings映射模板来动态创建。而age字段没有匹配到任何映射模板，那么它的数据类型依旧使用系统默认的设置。

◆ 字段路径映射是使用path_match或者path_unmatch参数的值来进行控制的


第3章 Elasticsearch字段类型

◆ 在Elasticsearch的映射关系中，每个字段都对应一个数据类型或者字段类型，这些类型规范了字段存储的值和用途。

◆ 可以将字符串索引到text和keyword字段。text字段的值用于全文搜索；keyword字段的值存储时不会被分词建立索引，主要用于统计计算等操作。

◆ Elasticsearch中的字段类型分为如下几类

◆ （1）常用类型binary：表示可以存储编码为Base64的字符串或者二进制值。boolean：表示可以存储true和false的布尔值。keyword：该字段类型的数据在存储时不会进行分词处理，适合进行统计分析，不能进行全文搜索。numbers：用于表示数字类型，例如long和double。date：表示可以存储日期类型的数据。alias：表示为现有字段定义别名。text：该字段类型的数据在存储时会进行分词并建立索引，适合进行全文搜索，不能进行统计分析。

◆ （2）对象和关系类型object：表示一个JSON对象。nested：嵌套类型，对象中可以嵌套对象。array：在Elasticsearch中，数组不需要专用的字段类型。默认情况下，任何字段都可以包含0个或多个值，但是数组中的所有值必须具有相同的字段类型。

◆ （3）其余类型range：表示范围类型。rank_feature：表示排名类型。token_count：表示令牌计数类型。ip：用于IP地址的存储和查询的类型。geo_point,geo_shape：用于地理位置和空间位置的存储与搜索的类型。


3.1 alias类型

◆ alias（别名）类型可以为索引中的字段定义一个替代名称。

◆ 别名不能用于数据的写入操作


3.2 数组类型

◆ 在Elasticsearch中，没有专用的数组数据类型。默认情况下，任何字段都可以包含0个或多个值，不过数组中的所有值必须具有相同的数据类型。

◆ 由以上语句可知，tags字段就是一个数组，里面的数据都是字符串类型

◆ 可以看到，包含Elasticsearch字符串结果的文档共有两条记录，说明数组字段类型的操作符合其定义说明。只要保证插入的数组字段中的数据类型是同一个类型，就能把数据写入此数组字段中


3.3 binary类型

◆ binary定义的字段类型可以存储编码为Base64的字符串或者二进制值


3.4 布尔类型

◆ 布尔字段类型可以存储true和false的布尔值，也可以存储 "true" 和 "false" 的字符串。


3.5 日期类型

◆ Elasticsearch中的日期类型可以是包含日期格式的字符串，例如"2021-01-01"或"2021/01/01 12:10:30"等格式，也可以使用自纪元以来的毫秒数来表示（注：在Unix中，纪元是指UTC时间1970年1月1日00:00:00）


3.6 nested类型

◆ nested（嵌套）类型是object数据类型的特殊版本，可以在对象中嵌套对象或在字段中存储键值对(Key-Value Pair)


3.7 range类型

◆ range（范围）类型表示介于上限和下限之间的连续值范围，可以使用运算符gt（大于）​、gte（大于等于）​、lt（小于）​、lte（小于等于）定义存储文档的数据范围。


3.8 数字类型

◆ Elasticsearch支持多种数字类型，每种数字类型的取值范围可以参照表3-2。


3.9 rank_feature类型

◆ rank_feature（排名）类型的字段可以存储数字，并且对搜索文档的分数有所影响（搜索文档的分数就是用户搜索的内容和搜索返回文档的匹配度，分数越高，就表示匹配度越高）​。范


3.10 search-as-you-type类型

◆ search_as_you_type字段类型和text字段类型很相似，Elasticsearch对其进行了优化，为用户提供了开箱即用的功能。


3.11 ip类型

◆ ip类型字段可以用于存储IPv4或IPv6地址。


3.12 token_count类型

◆ token_count（令牌计数）类型的字段实际上是一个integer类型字段，它可以对内容进行分词分析，存储内容被分词的数量。


3.13 object类型

◆ Elasticsearch中的object类型实际就是JSON数据格式，


3.14 geo_point类型

◆ 我们可能会遇到根据当前所在的位置找到离自己最近的符合条件的一些商店、酒店之类的情况。在Elasticsearch中也支持这种业务的查询，它主要支持两种类型的地理查询：一种是地理点(geo_point)查询，即经纬度查询；另一种是地理形状(geo_shape)查询，支持点、线、圈、多边形查询等。Elasticsearch也提供了地理点查询的类型，即geo_point类型


3.15 geo_shape类型

◆ geo_shape（空间位置）类型支持地理形状的搜索，即支持点、线、圈、多边形搜索等。


3.16 keyword类型

◆ keyword（关键字）类型用于存储结构化的内容，例如ID、电子邮件地址、主机名、状态代码、邮政编码或标签。此类型的字段通常用于排序、聚合查询等。


3.17 text类型

◆ text类型用于进行全文搜索（也称为全文检索）​，例如电子邮件正文或产品描述的全文，它们在被搜索之前通过分词器将全部文字内容转换为单词(term)表。txt类型允许用户在每个全文字段中搜索单个单词。text类型的字段不适合进行排序，也不适合进行聚合计算。如果字段需要聚合计算或者排序，推荐使用keyword类型。需要特别注意的是，keyword类型和text类型的区别是：keyword类型的字段内容不会被分词，text类型的字段内容会被分词（后续章节会专门讲解分词和分词原理）​。范


第4章 内置分词器和IK分词器

◆ “分词”是在Elasticsearch中进行存储和全文搜索的一个很重要的部分，因为只有选择合适的分词器才能更高效地进行全文搜索。Elasticsearch中提供了多种内置的分词器，针对不同的场景可以使用不同的分词器。这些分词器只对text类型字段有效，而对于keyword类型字段无效。


4.1 simple分词器

◆ simple分词器是对字母文本进行分词拆分，并将分词后的内容转换成小写格式。


4.2 simple_pattern分词器

◆ Elasticsearch还提供了根据正则表达式进行分词的分词器（simple_pattern分词器）​，范


4.4 standard分词器

◆ standard（标准）分词器是Elasticsearch中默认的分词器，它是基于Unicode文本分割算法进行分词的。


